#!/usr/bin/python

import ConfigParser
import logging
import ssl

from common import operations
from optparse import OptionParser

LOG = logging.getLogger(__name__)
CONFIG_FILE_PATH = '/usr/local/data/config.ini'


def main():
    try:
        _create_unverified_https_context = ssl._create_unverified_context
    except AttributeError:
        # Legacy Python that doesn't verify HTTPS certificates by default
        pass
    else:
        # Handle target environment that doesn't support HTTPS verification
        ssl._create_default_https_context = _create_unverified_https_context

    parser = OptionParser(usage='usage: %prog [options] arguments')
    parser.add_option("--vm", dest="vmotion_vm",
                      help="VM Name")
    parser.add_option("--dest-host", dest="dest_host",
                      help="Host Name")
    parser.add_option("--dest-datastore", dest="dest_datastore",
                      help="Datastore Name")
    (options, args) = parser.parse_args()

    vmotion_vm = None
    dest_host = None
    dest_datastore = None

    if options.vmotion_vm:
        vmotion_vm = options.vmotion_vm
    if options.dest_host:
        dest_host = options.dest_host
    if options.dest_datastore:
        dest_datastore = options.dest_datastore

    if vmotion_vm is None:
        parser.error('Failed to get VM.'
                     'Input vm_name with --vm')
    if dest_host is None:
        parser.error('Failed to get dest host.'
                     'Input host_name with --dest_host')
    if dest_datastore is None:
        parser.error('Failed to get dest datastore.'
                     'Input datastore_name with --dest_datastore')

    cf = ConfigParser.ConfigParser()
    cf.read(CONFIG_FILE_PATH)

    vc = operations.get_vcenter(cf)
    operations.vmotion(vc, vmotion_vm, dest_host, dest_datastore)


if __name__ == '__main__':
    main()
